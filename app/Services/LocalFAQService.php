<?php

namespace App\Services;

class LocalFAQService
{
    protected $knowledgeBase = [
        // 🎮 商品相關
        'products' => [
            'keywords' => [
                '商品', '購買', '買', '下單', '選購', '挑選', '產品', '物品',
                '東西', '貨', '逛', '看看', '有什麼', '賣什麼', '什麼商品',
                '遊戲', '虛寶', '道具', '裝備', '皮膚', 'skin', '角色',
                '寶物', '材料', '點數', '代幣', '金幣', '鑽石', '課金',
                '找', '尋找', '搜尋', '哪裡有', '想要', '需要'
            ],
            'responses' => [
                'default' => '🎮 **歡迎來到虛寶商城！**

我們提供多元的遊戲虛擬寶物：
- 各類遊戲道具、裝備
- 限定角色皮膚
- 遊戲點數、代幣
- 稀有材料、收藏品

**快速購物指南：**
1. 點選上方「市場」進入商城
2. 使用篩選功能選擇遊戲類型
3. 瀏覽商品並點擊查看詳情
4. 加入購物車或立即購買

需要特定商品推薦嗎？歡迎告訴我您玩的遊戲！',

                'how_to_buy' => '💳 **完整購買流程說明**

**步驟一：選擇商品**
- 在商品頁面點擊「加入購物車」
- 或直接點擊「立即購買」快速結帳

**步驟二：確認訂單**
- 前往購物車檢查商品
- 確認數量、價格無誤

**步驟三：填寫資料**
- 輸入收件資訊
- 填寫遊戲帳號或ID（若需要）

**步驟四：選擇付款方式**
- 信用卡、ATM轉帳、超商繳費等
- 選擇最方便的付款方式

**步驟五：完成付款**
- 依照指示完成付款
- 等待賣家交付商品

有任何疑問歡迎隨時詢問！',
            ],
        ],

        // 📦 訂單相關
        'orders' => [
            'keywords' => [
                '訂單', 'order', '查詢', '追蹤', '進度', '狀態',
                '我的訂單', '買的東西', '在哪', '到哪了', '收不到',
                '沒收到', '還沒到', '多久', '什麼時候', '何時',
                '訂單編號', '單號', '查單', '看訂單', '訂購紀錄',
                '歷史訂單', '過去', '之前買的'
            ],
            'responses' => [
                'default' => '📦 **訂單查詢方式**

**網頁版查詢：**
1. 登入您的帳號
2. 點擊右上角「我的訂單」
3. 即可查看所有訂單狀態

**手機版查詢：**
1. 點擊選單按鈕
2. 選擇「我的訂單」
3. 瀏覽訂單列表

**訂單狀態說明：**
- 💰 待付款 - 等待完成付款
- ⏳ 處理中 - 賣家準備商品
- 🚚 交付中 - 商品配送中
- ✅ 已完成 - 交易完成

若需查詢特定訂單，請提供訂單編號，我將協助您查詢。',

                'status' => '📊 **訂單狀態詳細說明**

**💰 待付款**
訂單已建立，等待您完成付款。
請在期限內完成付款，逾時將自動取消。

**⏳ 處理中**
付款已確認，賣家正在準備您的商品。
請耐心等候，通常不會太久。

**🚚 交付中**
賣家已發貨，商品正在交付給您。
依交付方式不同，時間會有差異。

**✅ 已完成**
交易完成！商品已成功交付。
歡迎給予評價，幫助其他買家參考。

**❌ 已取消**
訂單已取消，可能是逾時未付款或其他原因。

如對訂單狀態有疑問，歡迎隨時聯繫客服。',
            ],
        ],

        // 💳 付款相關
        'payment' => [
            'keywords' => [
                '付款', '支付', '刷卡', '轉帳', 'ATM', '信用卡', '超商', '繳費',
                '怎麼付', '如何付', '付錢', '結帳', '買單', 'pay', 'payment',
                'visa', 'master', 'jcb', '街口', 'line pay', 'apple pay',
                '錢包', '電子支付', '行動支付', '掃碼', '付不了', '刷不過',
                '付款方式', '可以用', '支援', '接受'
            ],
            'responses' => [
                'default' => '💰 **支援的付款方式**

我們提供多種安全便利的付款選項：

**💳 信用卡**
- Visa / Mastercard / JCB
- 即時扣款，快速完成交易
- 支援分期付款（依銀行規定）

**🏦 ATM 轉帳**
- 提供虛擬帳號
- 轉帳後自動對帳
- 3天內完成轉帳即可

**🏪 超商代碼繳費**
- 7-ELEVEN / 全家便利商店
- 取得繳費代碼後至櫃台繳款
- 3天內完成繳費

**💸 電子錢包**
- 街口支付 / LINE Pay
- 掃碼即可完成付款
- 快速又方便

**🔒 安全保障**
所有交易均採用 SSL 加密技術，確保您的資料安全。

如有付款問題，請告訴我詳細情況，我將協助您處理。',

                'failed' => '⚠️ **付款失敗處理方式**

遇到付款問題時，請依照以下步驟排除：

**常見原因與解決方法：**

**1. 餘額不足**
- 請確認帳戶或信用卡餘額充足
- 可嘗試更換其他付款方式

**2. 卡片資料錯誤**
- 檢查卡號、有效期限是否正確
- 確認卡片背面安全碼（CVV）

**3. 銀行風控機制**
- 可能觸發銀行的安全機制
- 建議聯繫發卡銀行確認

**4. 網路連線問題**
- 嘗試重新整理頁面
- 或更換其他裝置、網路環境

**5. 付款系統維護**
- 暫時選擇其他付款方式
- 或稍後再試

**仍無法解決？**
請聯繫我們的客服團隊：
📧 Email: support@cyim.com
💬 線上客服：週一至週五 09:00-18:00
📞 客服專線：(02) 1234-5678

我們將盡快協助您完成付款。',
            ],
        ],

        // 🔄 退貨退款
        'refund' => [
            'keywords' => [
                '退貨', '退款', '取消', '不要了', '申請退款', '退錢',
                '退', '退單', '想退', '可以退嗎', '能退嗎', '怎麼退',
                '不想要', '買錯', '不滿意', '後悔', '退費', 'refund',
                '退回', '退掉', '取消訂單', '撤單', '退訂'
            ],
            'responses' => [
                'default' => '🔄 **退貨退款政策**

**退款條件：**
✅ 購買後7天內可申請
✅ 虛擬商品須未使用
✅ 需提供完整訂單編號

**申請流程：**

**步驟一：進入訂單頁面**
登入後點選「我的訂單」

**步驟二：選擇訂單**
找到要退款的訂單並點擊進入

**步驟三：申請退款**
點擊「申請退款」按鈕

**步驟四：填寫原因**
簡述退款原因（必填）

**步驟五：送出申請**
確認資料後送出申請

**步驟六：等待審核**
我們將在1-3個工作天內審核

**注意事項：**
- 已使用的虛擬商品無法退款
- 退款金額將退回原付款方式
- 審核通過後3-7個工作天內退款

如有任何疑問，歡迎聯繫客服協助。',

                'time' => '⏱️ **退款處理時間說明**

**審核階段：**
- 時間：收到申請後1-3個工作天
- 週末及國定假日不計入工作天
- 審核結果將以Email通知

**退款階段：**
審核通過後，依付款方式不同：

- **信用卡**：5-7個工作天
  退款將顯示在下期帳單中

- **ATM轉帳**：3-5個工作天
  直接退回原轉出帳戶

- **超商繳費**：7-10個工作天
  將以匯款方式退回指定帳戶

- **電子錢包**：3-5個工作天
  退回原電子錢包帳戶

**到帳通知：**
退款完成後會收到簡訊或Email通知，
請留意查看您的帳戶。

**退款遲未到帳？**
若超過預期時間仍未收到退款，
請聯繫客服，我們將協助您追蹤處理。',
            ],
        ],

        // 💬 議價相關
        'bargain' => [
            'keywords' => [
                '議價', '殺價', '便宜', '折扣', '優惠', '降價', '砍價',
                '能不能便宜', '可以便宜嗎', '打折', '划算', '特價',
                '促銷', 'sale', '減價', '談價', '講價', '喊價',
                '算便宜', '算我便宜', '多少錢', '最低價', '底價',
                '議價功能', '如何議價', '怎麼議價'
            ],
            'responses' => [
                'default' => '💬 **議價功能使用指南**

我們提供便利的線上議價功能，讓您與賣家直接溝通價格。

**使用步驟：**

**1. 開啟對話**
在商品頁面點擊「聯繫賣家」

**2. 進入議價模式**
聊天室中點擊「議價」按鈕

**3. 提出期望價格**
輸入您認為合理的價格

**4. 等待賣家回應**
賣家可能會：
- ✅ 接受您的出價
- ❌ 拒絕議價
- 🔄 提出反議價

**5. 達成協議**
雙方同意價格後即可成交

**議價建議：**

📊 **參考歷史成交價**
查看商品的歷史成交區間，作為出價參考

🗣️ **禮貌溝通**
保持良好的溝通態度，更容易達成共識

💪 **合理出價**
過低的出價可能會被拒絕，建議合理評估

🔄 **多輪協商**
一次議價不成功，可以繼續協商

歡迎嘗試議價功能，祝您談到好價格！',
            ],
        ],

        // 👤 帳號相關
        'account' => [
            'keywords' => [
                '帳號', '登入', '註冊', '密碼', '忘記密碼', '會員', 'login', 'register',
                'email', '信箱', '帳戶', 'account', '個人資料', '修改',
                '登不進去', '進不去', '無法登入', '密碼錯誤', '忘了',
                '改密碼', '換密碼', '重設', 'reset', '驗證', '認證',
                '會員註冊', '加入會員', '註冊帳號'
            ],
            'responses' => [
                'default' => '👤 **帳號相關服務**

**新用戶註冊：**
1. 點擊右上角「註冊」按鈕
2. 填寫Email和設定密碼
3. 驗證Email信箱
4. 完成註冊，開始購物

**會員登入：**
1. 點擊右上角「登入」
2. 輸入Email和密碼
3. 可勾選「記住我」保持登入狀態

**忘記密碼？**
請點選登入頁面的「忘記密碼」連結，
我將引導您完成密碼重設。

**修改個人資料：**
登入後前往「個人設定」頁面，
可修改Email、密碼、個人資訊等。

**帳號安全提醒：**
- 請勿與他人共用帳號密碼
- 建議定期更換密碼
- 使用強度較高的密碼組合

有其他帳號問題嗎？歡迎詢問！',

                'forgot_password' => '🔑 **密碼重設步驟**

請依照以下步驟重設您的密碼：

**步驟一：點擊忘記密碼**
在登入頁面下方找到「忘記密碼」連結

**步驟二：輸入註冊Email**
輸入您當初註冊時使用的Email地址

**步驟三：收取重設郵件**
檢查您的信箱（包含垃圾郵件匣）
郵件標題為「密碼重設通知」

**步驟四：點擊重設連結**
開啟郵件並點擊「重設密碼」按鈕

**步驟五：設定新密碼**
輸入新密碼兩次確認
建議使用英數字混合，長度8位以上

**步驟六：完成重設**
使用新密碼登入您的帳號

**重要提醒：**
- 重設連結24小時內有效
- 連結過期需重新申請
- 收不到郵件請確認Email地址是否正確

**仍無法重設？**
請聯繫客服，提供您的註冊Email，
我們將協助您處理。',
            ],
        ],

        // 🏪 賣家相關
        'seller' => [
            'keywords' => [
                '賣家', '上架', '販售', '開店', '賣東西', '成為賣家', '我要賣',
                '怎麼賣', '如何賣', '賣商品', '當賣家', 'seller', '商家',
                '賣出', '出售', '拍賣', '刊登', '發布', '放上去',
                '開賣', '開始賣', '想賣', '要賣', '成為商家'
            ],
            'responses' => [
                'default' => '🏪 **成為賣家指南**

歡迎加入我們的賣家行列！

**申請成為賣家：**

**步驟一：註冊會員**
如還未註冊，請先完成會員註冊

**步驟二：進入賣家中心**
登入後，點選「賣家中心」

**步驟三：新增商品**
點擊「新增商品」開始刊登

**步驟四：填寫商品資訊**
- 商品名稱（清楚明確）
- 遊戲類型（選擇正確分類）
- 商品類別（道具/皮膚/點數等）
- 價格設定（可開放議價）
- 庫存數量
- 詳細說明（越詳細越好）

**步驟五：上傳商品圖片**
- 建議上傳3-5張清晰圖片
- 第一張為主要展示圖
- 圖片尺寸建議800x800以上

**步驟六：設定交付方式**
- 選擇自動發貨或手動交付
- 填寫交付說明
- 設定預計交付時間

**步驟七：發布商品**
確認所有資訊無誤後發布
等待平台審核（通常1個工作天）

**賣家福利：**
✅ 零上架費用
✅ 安全金流系統
✅ 即時通訊功能
✅ 訂單管理系統
✅ 銷售數據分析

**經營建議：**
- 商品說明力求詳盡
- 價格參考市場行情
- 快速回覆買家詢問
- 準時交付商品
- 維持良好評價

有任何問題歡迎詢問，祝您銷售順利！',
            ],
        ],

        // 🔧 技術問題
        'technical' => [
            'keywords' => [
                '技術', '錯誤', 'bug', '無法', '不能', '問題', '壞掉', '故障',
                '當機', '卡住', '怪怪的', '不正常', '沒反應', 'error',
                '跑不動', '開不了', '載不了', '顯示錯誤', '出錯',
                '404', '500', '網頁', '系統', 'crash', '閃退',
                '異常', '失敗', '無法使用', '不能用'
            ],
            'responses' => [
                'default' => '🔧 **技術支援服務**

很抱歉您遇到技術問題，我將協助您排除。

**請提供以下資訊：**

1️⃣ **問題描述**
   具體說明發生什麼狀況

2️⃣ **發生位置**
   在哪個頁面或功能出現問題

3️⃣ **使用裝置**
   電腦、手機或平板？作業系統版本？

4️⃣ **錯誤訊息**
   如有錯誤訊息，請提供完整內容
   或截圖給我們

**基本排除步驟：**

🔄 **重新整理頁面**
按 F5 或點擊重新整理

🌐 **清除瀏覽器快取**
清除Cookie和快取資料

📱 **更換瀏覽器**
嘗試使用其他瀏覽器

🔌 **檢查網路連線**
確認網路連線穩定

**聯繫技術團隊：**

如上述方法無法解決，請聯繫我們：

📧 **Email支援**
support@cyim.com
請附上問題截圖

💬 **線上客服**
週一至週五 09:00-18:00
即時協助處理

📞 **客服專線**
(02) 1234-5678
上班時間服務

我們會盡快為您解決問題！',
            ],
        ],

        // 🚚 運費/交付
        'shipping' => [
            'keywords' => [
                '運費', '配送', '物流', '送貨', '寄送', '郵費',
                '怎麼拿', '如何拿', '怎麼收', '交付', '交貨',
                '多久到', '什麼時候到', '幾天', '到貨', '收貨',
                '交付方式', '如何交付', '怎麼交付'
            ],
            'responses' => [
                'default' => '🚚 **商品交付說明**

**虛擬商品交付特色：**
✅ 完全線上交付
✅ 無需支付運費
✅ 快速便利

**交付方式說明：**

**⚡ 自動發貨**
- 系統自動發送
- 付款完成後立即到帳
- 通常1分鐘內完成

**👤 手動交付**
- 賣家人工處理
- 依賣家回應速度
- 通常1-2小時內

**🎮 遊戲內交易**
- 與賣家約定時間
- 在遊戲中面交
- 最安全的交付方式

**交付時間參考：**
- 自動發貨：即時
- 手動交付：1-24小時
- 遊戲內交易：依約定時間

**收貨注意事項：**
1. 確認已完成付款
2. 檢查訂單狀態
3. 注意賣家訊息通知
4. 收到後立即確認

**未收到商品？**
- 檢查訂單狀態是否為「已交付」
- 查看賣家是否有發送訊息
- 聯繫賣家詢問進度
- 超過承諾時間可申訴

有任何交付問題歡迎詢問！',
            ],
        ],

        // 🛡️ 安全相關
        'security' => [
            'keywords' => [
                '安全', '詐騙', '被騙', '假貨', '保障', '信任',
                '可靠嗎', '安全嗎', '會不會', '怕被騙', '靠譜',
                '真的假的', '有保障嗎', '風險', '黑單', '盜帳',
                '個資', '隱私', '資料安全', '可信', '信賴'
            ],
            'responses' => [
                'default' => '🛡️ **交易安全保障機制**

您的交易安全是我們最重視的事項。

**多重安全保護：**

✅ **賣家身份驗證**
所有賣家需通過實名認證
確保賣家身份真實可靠

🔒 **第三方金流**
採用安全的第三方支付系統
買賣雙方資金受到保護

💰 **退款保證**
7天鑑賞期保障
不滿意可申請退款

🆘 **全天候客服**
24/7客服支援
隨時協助處理問題

**防詐騙指南：**

**❌ 絕對不要：**
- 私下交易或匯款
- 透過站外通訊軟體交易
- 提供帳號密碼給任何人
- 相信過度優惠的交易

**✅ 務必做到：**
- 只在平台內進行交易
- 使用平台提供的聊天功能
- 確認收到商品再確認訂單
- 發現異常立即回報

**遇到可疑狀況？**

1. **立即停止交易**
   不要繼續進行任何操作

2. **保留證據**
   截圖對話記錄和交易資訊

3. **回報平台**
   立即聯繫客服團隊
   我們會立即處理

4. **協助處理**
   配合平台調查
   保障您的權益

**已遭遇詐騙？**
請立即聯繫我們：
📧 support@cyim.com
📞 (02) 1234-5678

越早處理，越能保障您的權益！',
            ],
        ],

        // 🎁 優惠活動
        'promotion' => [
            'keywords' => [
                '優惠', '活動', '折扣', '促銷', 'sale', '特價',
                '折價券', '優惠券', 'coupon', '代碼', 'code',
                '有沒有', '現在', '最近', '打折', '便宜',
                '新人', '首購', '回饋', '紅利', '點數',
                '優惠碼', '折扣碼', '推薦碼'
            ],
            'responses' => [
                'default' => '🎁 **優惠活動資訊**

**目前進行中的優惠：**

🆕 **新會員優惠**
首次註冊即贈100元購物金
首次購買享額外折扣

💎 **每日精選**
每天推出限量特惠商品
數量有限，售完為止

🎯 **會員回饋**
消費累積紅利點數
下次購物可折抵使用

🎉 **節慶活動**
重要節日推出特別優惠
會員優先通知

**如何使用優惠券：**

**步驟一：取得優惠碼**
- 活動頁面領取
- Email通知
- 客服發送

**步驟二：結帳時輸入**
在結帳頁面找到「優惠碼」欄位

**步驟三：套用優惠**
輸入代碼後點擊「套用」

**步驟四：確認折扣**
確認金額已扣除優惠

**步驟五：完成付款**
確認無誤後完成結帳

**優惠碼使用注意：**
- 注意使用期限
- 部分優惠不可合併使用
- 每筆訂單限用一組優惠碼
- 退款不退還使用的優惠券

**訂閱優惠通知：**
不想錯過任何優惠？
到「個人設定」開啟通知
第一時間收到優惠資訊！',
            ],
        ],

        // 💬 客服相關
        'customer_service' => [
            'keywords' => [
                '客服', '真人', '人工', '找人', '聯絡', '聯繫',
                '打電話', '電話', '信箱', 'email', '客服人員',
                '反應', '反映', '投訴', '抱怨', '申訴', '建議',
                '意見', 'feedback', '回饋'
            ],
            'responses' => [
                'default' => '💬 **客服聯繫方式**

我們提供多種客服管道，方便您聯繫：

**📧 Email客服**
support@cyim.com
- 全年無休
- 24小時內回覆
- 適合詳細問題說明

**💬 線上即時客服**
- 服務時間：週一至週五 09:00-18:00
- 點擊右下角對話視窗
- 真人客服即時回應

**📞 客服專線**
(02) 1234-5678
- 服務時間：週一至週五 09:00-18:00
- 直接語音溝通
- 快速解決問題

**💭 LINE官方帳號**
搜尋「@virtualgoodsshop」
- 加入官方帳號
- 接收最新消息
- 隨時提問

**聯繫前準備：**
✅ 訂單編號（如有相關訂單）
✅ 問題截圖或照片
✅ 詳細問題描述
✅ 聯絡資訊

**客服可協助您：**
- 訂單查詢與處理
- 付款問題排除
- 退款申請
- 帳號問題
- 技術支援
- 投訴與建議
- 其他任何問題

**客服處理時效：**
- 一般問題：1個工作天內回覆
- 緊急問題：4小時內回應
- 退款申請：1-3個工作天處理

我是AI客服，能為您解答大部分問題。
若需要真人協助，歡迎使用上述管道聯繫！',
            ],
        ],

        // 😊 一般對話
        'greeting' => [
            'keywords' => [
                '你好', 'hi', 'hello', '嗨', '您好', '安安',
                '謝謝', 'thanks', '感謝', 'thank you',
                '再見', 'bye', '掰掰', '拜拜',
                '你是誰', '你叫什麼', '什麼AI', '哪位'
            ],
            'responses' => [
                'default' => '您好！我是AI智能客服 🤖

很高興為您服務！

我可以協助您：
- 解答購物相關問題
- 查詢訂單狀態
- 說明平台功能
- 提供操作指引
- 解決技術問題

不確定要問什麼嗎？
可以點選下方的快速問題，
或直接輸入您想了解的內容。

如需人工客服協助，
請告訴我，我會為您轉接！',
            ],
        ]
    ];

    /**
     * 分析使用者訊息並回覆
     */
    public function getResponse(string $userMessage): ?array
    {
        $userMessage = mb_strtolower($userMessage);

        // 遍歷知識庫
        foreach ($this->knowledgeBase as $category => $data) {
            foreach ($data['keywords'] as $keyword) {
                if (mb_strpos($userMessage, $keyword) !== false) {
                    return [
                        'matched' => true,
                        'category' => $category,
                        'response' => $this->selectBestResponse($data['responses'], $userMessage),
                        'source' => 'local',
                    ];
                }
            }
        }

        return null;
    }

    /**
     * 選擇最佳回應
     */
    protected function selectBestResponse(array $responses, string $userMessage): string
    {
        // 怎麼/如何 → 教學類回答
        if (mb_strpos($userMessage, '怎麼') !== false ||
            mb_strpos($userMessage, '如何') !== false ||
            mb_strpos($userMessage, '怎樣') !== false) {
            return $responses['how_to_buy'] ?? $responses['how_to'] ?? $responses['default'];
        }

        // 狀態/進度查詢
        if (mb_strpos($userMessage, '狀態') !== false ||
            mb_strpos($userMessage, '進度') !== false ||
            mb_strpos($userMessage, '到哪') !== false) {
            return $responses['status'] ?? $responses['default'];
        }

        // 失敗/錯誤處理
        if (mb_strpos($userMessage, '失敗') !== false ||
            mb_strpos($userMessage, '錯誤') !== false ||
            mb_strpos($userMessage, '不能') !== false ||
            mb_strpos($userMessage, '無法') !== false) {
            return $responses['failed'] ?? $responses['default'];
        }

        // 時間相關
        if (mb_strpos($userMessage, '時間') !== false ||
            mb_strpos($userMessage, '多久') !== false ||
            mb_strpos($userMessage, '幾天') !== false) {
            return $responses['time'] ?? $responses['default'];
        }

        // 忘記密碼
        if (mb_strpos($userMessage, '忘記') !== false &&
            mb_strpos($userMessage, '密碼') !== false) {
            return $responses['forgot_password'] ?? $responses['default'];
        }

        return $responses['default'];
    }

    /**
     * 取得所有分類
     */
    public function getCategories(): array
    {
        return array_keys($this->knowledgeBase);
    }

    /**
     * 取得快速回覆建議
     */
    public function getQuickReplies(): array
    {
        return [
            '商品如何購買？',
            '如何查詢訂單？',
            '退貨政策說明',
            '議價功能教學',
            '付款方式有哪些？',
            '如何成為賣家？',
            '忘記密碼怎麼辦？',
            '有優惠活動嗎？',
        ];
    }
}
